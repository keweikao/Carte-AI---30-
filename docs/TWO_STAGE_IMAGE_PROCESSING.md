# 兩階段智能圖片處理系統

**實作日期**: 2025-12-03  
**功能**: 提高菜單提取成功率

---

## 🎯 問題分析

### 原有系統的限制
- 只處理前 5 張圖片（API 限制）
- 無法判斷哪些圖片包含菜單
- 可能浪費 API 配額在非菜單圖片上

### 實際案例（忠南飯館）
- Apify 拉回 10 張圖片
- 只有 1-2 張可能是菜單
- 其他是餐廳外觀、環境照片
- 結果：只提取到 2 個菜品（失敗）

---

## ✨ 新系統設計

### 兩階段處理流程

```
10 張圖片
    ↓
┌─────────────────────────────────────┐
│ Stage 1: 智能分類（輕量級）          │
│ - 使用 gemini-2.0-flash-exp         │
│ - 快速判斷哪些圖片包含菜單           │
│ - 處理所有 10 張圖片                │
│ - 時間: ~5-8 秒                     │
└─────────────────────────────────────┘
    ↓
找到 2-3 張菜單圖片
    ↓
┌─────────────────────────────────────┐
│ Stage 2: OCR 提取（完整模型）        │
│ - 使用 gemini-2.5-flash             │
│ - 只處理菜單圖片                    │
│ - 詳細提取菜名和價格                │
│ - 時間: ~10-15 秒                   │
└─────────────────────────────────────┘
    ↓
提取到 10-20 個菜品 ✅
```

---

## 📊 Stage 1: 圖片分類

### 功能
- 快速判斷每張圖片是否為菜單
- 提供信心分數和理由

### 輸入
```python
image_urls = [
    "https://lh3.googleusercontent.com/...",  # 圖片 1
    "https://lh3.googleusercontent.com/...",  # 圖片 2
    # ... 共 10 張
]
```

### 輸出
```json
{
  "classifications": [
    {
      "image_index": 0,
      "is_menu": false,
      "confidence": 0.9,
      "reason": "餐廳外觀照片"
    },
    {
      "image_index": 3,
      "is_menu": true,
      "confidence": 0.95,
      "reason": "包含多個菜品名稱和價格"
    },
    {
      "image_index": 5,
      "is_menu": true,
      "confidence": 0.85,
      "reason": "牆上的菜單板"
    }
  ]
}
```

### Prompt 設計
```
你是一個專業的圖片分類助手。請分析這些圖片，判斷哪些圖片包含菜單資訊。

菜單圖片的特徵：
- 包含菜品名稱和價格的列表
- 可能是紙本菜單、電子菜單、或牆上的菜單板
- 包含多個菜品項目

非菜單圖片：
- 餐廳外觀
- 室內環境
- 單一菜品照片（沒有價格）
- 顧客用餐照片
```

---

## 📋 Stage 2: OCR 提取

### 功能
- 只處理已確認的菜單圖片
- 詳細提取菜名、價格、分類、描述

### 輸入
```python
menu_image_urls = [
    "https://lh3.googleusercontent.com/...",  # 菜單圖片 1
    "https://lh3.googleusercontent.com/...",  # 菜單圖片 2
]
```

### 輸出
```json
[
  {
    "name": "宮保雞丁",
    "price": 180,
    "category": "主菜",
    "description": "經典川菜"
  },
  {
    "name": "酸辣湯",
    "price": 60,
    "category": "湯品",
    "description": null
  }
]
```

### Prompt 優化
```
你是一個專業的菜單 OCR 助手。請從這些菜單圖片中提取所有菜色資訊。

重要規則：
1. 只提取有明確價格的菜色
2. 價格必須是數字（台幣，去除 $ 符號）
3. 合併所有圖片中的菜單項目  ← 新增
4. 盡可能識別菜色類別
5. 若有描述文字也請一併提取
```

---

## 🎯 預期改善

### 提取成功率
| 指標 | 原系統 | 新系統 | 改善 |
|------|--------|--------|------|
| 處理圖片數 | 5 張（固定） | 2-5 張（智能） | 更精準 |
| 菜單圖片命中率 | 20-40% | 80-100% | **+200%** |
| 提取菜品數 | 2-5 個 | 10-30 個 | **+400%** |
| API 配額利用率 | 低 | 高 | 更有效 |

### 時間成本
| 階段 | 時間 | 說明 |
|------|------|------|
| Stage 1: 分類 | 5-8s | 處理 10 張圖片 |
| Stage 2: OCR | 10-15s | 處理 2-5 張菜單 |
| **總計** | **15-23s** | 比原系統略慢但更準確 |

### 成本效益
- **API 呼叫次數**: 2 次（分類 + OCR）
- **處理圖片總數**: 10 張（分類）+ 2-5 張（OCR）
- **成功率提升**: 200-400%
- **ROI**: 非常高 ✅

---

## 🔧 技術實作

### 檔案位置
`services/pipeline/intelligence.py`

### 新增方法
```python
async def _classify_images(self, image_urls: List[str]) -> List[str]:
    """
    Stage 1: Quickly classify images to find menu images
    
    Returns:
        List of image URLs that likely contain menus
    """
```

### 修改方法
```python
async def parse_from_images(self, image_urls: List[str]) -> List[ParsedMenuItem]:
    """
    Two-stage intelligent processing:
    1. Classify all images
    2. OCR only on menu images
    """
```

---

## 📊 測試案例

### 忠南飯館（預期）

#### 輸入
- 10 張 Google Maps 圖片

#### Stage 1 輸出（預期）
```
[MenuParser] Found 2 menu images out of 10 total
  ✓ Image 4 is menu (confidence: 0.95) - 包含多個菜品名稱和價格
  ✓ Image 7 is menu (confidence: 0.85) - 牆上的菜單板
```

#### Stage 2 輸出（預期）
```
[MenuParser] ✓ Extracted 15 items from 2 menu images
  1. 回鍋肉 - $280
  2. 三杯雞 - $250
  3. 糖醋排骨 - $300
  ... (共 15 個菜品)
```

---

## 🚀 部署計劃

### 1. 本地測試
```bash
# 測試新的圖片處理邏輯
python3 test_zhongnan_complete.py
```

### 2. 部署到 Staging
```bash
gcloud builds submit --config=cloudbuild.yaml
```

### 3. 驗證
- 檢查日誌中的分類結果
- 確認提取的菜品數量
- 驗證總處理時間

---

## 💡 未來優化

### 短期（1-2 週）
1. **調整信心閾值**: 只處理 confidence > 0.7 的菜單圖片
2. **並行處理**: Stage 1 和 Stage 2 可以部分並行
3. **快取分類結果**: 相同餐廳的圖片不需重複分類

### 中期（1-2 月）
1. **訓練專用模型**: 使用 Fine-tuned 模型提高分類準確度
2. **圖片預處理**: 自動裁切、增強對比度
3. **多語言支持**: 支援英文、日文菜單

### 長期（3-6 月）
1. **視覺化工具**: 讓用戶手動選擇菜單圖片
2. **眾包驗證**: 收集用戶反饋改進模型
3. **A/B 測試**: 比較不同策略的效果

---

## 📝 總結

### ✅ 優勢
1. **更高的成功率**: 智能選擇菜單圖片
2. **更好的資源利用**: 不浪費 API 配額
3. **更多的菜品**: 可能提取 10-30 個菜品
4. **可擴展性**: 容易加入更多優化

### ⚠️ 注意事項
1. **時間增加**: 總時間從 16s 增加到 15-23s
2. **API 呼叫**: 需要 2 次 Gemini API 呼叫
3. **錯誤處理**: 需要處理分類失敗的情況

### 🎯 結論
這是一個值得實作的優化，預期可以大幅提高菜單提取成功率，特別是對於像忠南飯館這樣缺少線上菜單的餐廳。

---

**實作狀態**: ✅ 已完成  
**待部署**: 是  
**預期效果**: 提取成功率 +200-400%
