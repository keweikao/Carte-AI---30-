name: Carte AI Design - Migration Test

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'frontend/carte-ai-design/**'
      - '.github/workflows/carte-ai-design-test.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'frontend/carte-ai-design/**'
  workflow_dispatch:

jobs:
  migration-completeness-test:
    name: è¨­è¨ˆé·ç§»å®Œæ•´æ€§æ¸¬è©¦
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend/carte-ai-design
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ğŸ è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“‹ åŸ·è¡Œå®Œæ•´æ€§æ¸¬è©¦
        id: test
        run: |
          echo "ğŸš€ é–‹å§‹åŸ·è¡Œ Carte AI è¨­è¨ˆé·ç§»å®Œæ•´æ€§æ¸¬è©¦..."
          python3 test_migration_completeness.py
      
      - name: ğŸ“Š é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦
        if: always()
        run: |
          echo "ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦:"
          python3 show_test_summary.py
      
      - name: ğŸ“„ ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-test-report
          path: |
            frontend/carte-ai-design/test_migration_report.json
            frontend/carte-ai-design/docs/MIGRATION_TEST_REPORT.md
          retention-days: 30
      
      - name: ğŸ’¬ å»ºç«‹æ¸¬è©¦å ±å‘Šè¨»è§£ (PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'frontend/carte-ai-design/test_migration_report.json';
            
            let report;
            try {
              report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            } catch (error) {
              console.log('ç„¡æ³•è®€å–æ¸¬è©¦å ±å‘Š');
              return;
            }
            
            const passed = report.passed || 0;
            const failed = report.failed || 0;
            const warnings = report.warnings || 0;
            const total = passed + failed;
            const percentage = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            const statusEmoji = percentage == 100 ? 'ğŸ‰' : percentage >= 90 ? 'ğŸ‘' : percentage >= 70 ? 'âš ï¸' : 'âŒ';
            
            let comment = `## ${statusEmoji} Carte AI è¨­è¨ˆé·ç§»æ¸¬è©¦å ±å‘Š\n\n`;
            comment += `**å®Œæˆåº¦**: ${percentage}% (${passed}/${total})\n\n`;
            comment += `| ç‹€æ…‹ | æ•¸é‡ |\n`;
            comment += `|------|------|\n`;
            comment += `| âœ… é€šé | ${passed} |\n`;
            comment += `| âŒ å¤±æ•— | ${failed} |\n`;
            comment += `| âš ï¸ è­¦å‘Š | ${warnings} |\n\n`;
            
            if (failed > 0) {
              comment += `### âŒ å¤±æ•—é …ç›®\n\n`;
              report.details.failed.forEach(item => {
                comment += `- **${item.test}**: ${item.detail}\n`;
              });
              comment += `\n`;
            }
            
            if (warnings > 0) {
              comment += `### âš ï¸ è­¦å‘Šé …ç›®\n\n`;
              report.details.warnings.forEach(item => {
                comment += `- **${item.test}**: ${item.detail}\n`;
              });
              comment += `\n`;
            }
            
            comment += `\nğŸ“„ è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹ Artifacts ä¸­çš„ \`migration-test-report\`\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: âœ… æ¸¬è©¦çµæœæª¢æŸ¥
        if: always()
        run: |
          if [ -f test_migration_report.json ]; then
            FAILED=$(python3 -c "import json; print(json.load(open('test_migration_report.json'))['failed'])")
            if [ "$FAILED" -gt 0 ]; then
              echo "âŒ æ¸¬è©¦å¤±æ•—: $FAILED å€‹é …ç›®æœªé€šé"
              exit 1
            else
              echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé!"
            fi
          else
            echo "âŒ æ‰¾ä¸åˆ°æ¸¬è©¦å ±å‘Š"
            exit 1
          fi
