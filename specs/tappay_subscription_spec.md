# TapPay è¨‚é–±åˆ¶å¯¦ä½œè¦æ ¼

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-11-24
**é‡‘æµæœå‹™å•†**: TapPay
**å„ªå‹¢**: ç„¡è·³è½‰é é¢ã€ç¾ä»£åŒ– APIã€ä½¿ç”¨è€…é«”é©—ä½³

---

## ğŸ“‹ ç›®éŒ„

1. [ç‚ºä»€éº¼é¸æ“‡ TapPay](#ç‚ºä»€éº¼é¸æ“‡-tappay)
2. [TapPay vs ECPay æ¯”è¼ƒ](#tappay-vs-ecpay-æ¯”è¼ƒ)
3. [å®šæœŸå®šé¡å¯¦ä½œåŸç†](#å®šæœŸå®šé¡å¯¦ä½œåŸç†)
4. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
5. [API æ•´åˆ](#api-æ•´åˆ)
6. [è³‡æ–™çµæ§‹](#è³‡æ–™çµæ§‹)
7. [å¯¦ä½œæµç¨‹](#å¯¦ä½œæµç¨‹)
8. [å®‰å…¨æ€§è€ƒé‡](#å®‰å…¨æ€§è€ƒé‡)

---

## ç‚ºä»€éº¼é¸æ“‡ TapPay

### æ ¸å¿ƒå„ªå‹¢

1. **âœ… ç„¡è·³è½‰ä»˜æ¬¾é é¢**
   - ä½¿ç”¨è€…å…¨ç¨‹ç•™åœ¨ä½ çš„ç¶²ç«™
   - ä¸æœƒè¢«å°å‘ç¬¬ä¸‰æ–¹é é¢
   - å“ç‰Œé«”é©—ä¸€è‡´

2. **âœ… æ”¯æ´å®šæœŸå®šé¡æ‰£æ¬¾**
   - é€é `card_key` + `card_token` æ©Ÿåˆ¶
   - è‡ªè¡Œæ§åˆ¶æ‰£æ¬¾é€±æœŸå’Œé‡‘é¡
   - éˆæ´»åº¦é«˜

3. **âœ… ç¾ä»£åŒ– API è¨­è¨ˆ**
   - RESTful API
   - å®Œæ•´çš„ SDKï¼ˆPython, Node.js, PHPï¼‰
   - æ–‡ä»¶æ¸…æ™°æ˜“æ‡‚

4. **âœ… é–‹ç™¼è€…å‹å–„**
   - æ²™ç®±ç’°å¢ƒå®Œæ•´
   - Webhook æ©Ÿåˆ¶å®Œå–„
   - éŒ¯èª¤è¨Šæ¯æ˜ç¢º

5. **âœ… æ‰‹çºŒè²»åˆç†**
   - 2.8%ï¼ˆèˆ‡ ECPay ç›¸åŒï¼‰
   - ç„¡é¡å¤–è¨­å®šè²»
   - ç„¡æœˆè²»

### é©åˆå ´æ™¯

- âœ… SaaS è¨‚é–±æœå‹™
- âœ… æœƒå“¡åˆ¶ç¶²ç«™
- âœ… ç·šä¸Šèª²ç¨‹å¹³å°
- âœ… å…§å®¹è¨‚é–±å¹³å°

---

## TapPay vs ECPay æ¯”è¼ƒ

| é …ç›® | TapPay | ECPay |
|-----|--------|-------|
| **ä»˜æ¬¾é«”é©—** | ç•™åœ¨ç¶²ç«™å…§ âœ… | è·³è½‰åˆ° ECPay âŒ |
| **å®šæœŸå®šé¡** | card_token æ©Ÿåˆ¶ âœ… | å®šæœŸå®šé¡ API âœ… |
| **API è¨­è¨ˆ** | ç¾ä»£åŒ– RESTful âœ… | è¼ƒå‚³çµ± âš ï¸ |
| **æ‰‹çºŒè²»** | 2.8% | 2.8% + NT$5 |
| **é–‹ç™¼é›£åº¦** | ä¸­ç­‰ | è¼ƒé«˜ |
| **æ–‡ä»¶å“è³ª** | å„ªç§€ âœ… | å®Œæ•´ä½†è¤‡é›œ âš ï¸ |
| **æ²™ç®±ç’°å¢ƒ** | å®Œæ•´ âœ… | å®Œæ•´ âœ… |
| **æ”¯æ´ä»˜æ¬¾æ–¹å¼** | ä¿¡ç”¨å¡ã€Apple Payã€Google Pay | ä¿¡ç”¨å¡ã€è¶…å•†ã€ATMã€è™›æ“¬å¸³è™Ÿ |
| **å¸‚ä½”ç‡** | ä¸­ç­‰ï¼ˆæ–°å‰µå¸¸ç”¨ï¼‰| æœ€é«˜ï¼ˆå‚³çµ±é›»å•†ï¼‰|

### æ±ºç­–å»ºè­°

**é¸æ“‡ TapPay å¦‚æœ**ï¼š
- å¸Œæœ›æä¾›æµæš¢çš„ä»˜æ¬¾é«”é©—
- ä¸»è¦å®¢ç¾¤ä½¿ç”¨ä¿¡ç”¨å¡
- é‡è¦–å“ç‰Œä¸€è‡´æ€§
- é–‹ç™¼åœ˜éšŠç†Ÿæ‚‰ç¾ä»£ API

**é¸æ“‡ ECPay å¦‚æœ**ï¼š
- éœ€è¦æ”¯æ´è¶…å•†/ATM ä»˜æ¬¾
- å®¢ç¾¤è¼ƒç¿’æ…£å‚³çµ±é‡‘æµ
- éœ€è¦æœ€é«˜å¸‚ä½”ç‡ä¿è­‰

**OderWhat å»ºè­°**: é¸æ“‡ **TapPay**
- ç›®æ¨™å®¢ç¾¤ï¼šå¹´è¼•ä¸Šç­æ—ï¼ˆç¿’æ…£ä¿¡ç”¨å¡ï¼‰
- é‡è¦– UXï¼šä¸æƒ³è·³è½‰é›¢é–‹ç¶²ç«™
- SaaS è¨‚é–±æ¨¡å¼ï¼šé©åˆ TapPay

---

## å®šæœŸå®šé¡å¯¦ä½œåŸç†

### æ ¸å¿ƒæ©Ÿåˆ¶ï¼šCard Tokenization

```
ç¬¬ä¸€æ¬¡ä»˜æ¬¾ï¼š
  ä½¿ç”¨è€…è¼¸å…¥å¡è™Ÿ â†’ TapPay JS SDK ç”¢ç”Ÿ prime
  â†’ å¾Œç«¯å‘¼å« Pay by Prime API (remember=true)
  â†’ TapPay è¿”å› card_key + card_token
  â†’ å¾Œç«¯å„²å­˜ token

å¾ŒçºŒæ‰£æ¬¾ï¼š
  æ’ç¨‹è§¸ç™¼ â†’ å¾Œç«¯å‘¼å« Pay by Card Token API
  â†’ ä½¿ç”¨å„²å­˜çš„ card_key + card_token
  â†’ è‡ªå‹•æ‰£æ¬¾æˆåŠŸ/å¤±æ•—
```

### é—œéµåƒæ•¸

#### 1. Primeï¼ˆé¦–æ¬¡ä»˜æ¬¾ï¼‰

```javascript
// å‰ç«¯ï¼šä½¿ç”¨è€…è¼¸å…¥å¡è™Ÿå¾Œå–å¾— prime
TPDirect.card.getPrime((result) => {
  if (result.status !== 0) {
    alert('å–å¾— prime å¤±æ•—ï¼š' + result.msg);
    return;
  }

  const prime = result.card.prime;
  // å°‡ prime å‚³çµ¦å¾Œç«¯
});
```

#### 2. Card Key + Card Tokenï¼ˆå®šæœŸæ‰£æ¬¾ç”¨ï¼‰

```python
# å¾Œç«¯ï¼šé¦–æ¬¡ä»˜æ¬¾æ™‚å–å¾—
response = tappay.pay_by_prime({
    'prime': prime,
    'partner_key': PARTNER_KEY,
    'merchant_id': MERCHANT_ID,
    'amount': 99,
    'currency': 'TWD',
    'remember': True,  # ğŸ”‘ é—œéµï¼šé–‹å•Ÿè¨˜æ†¶åŠŸèƒ½
    'cardholder': {
        'phone_number': user.phone,
        'name': user.name,
        'email': user.email
    }
})

if response['status'] == 0:
    # å„²å­˜é€™å…©å€‹åƒæ•¸
    card_key = response['card_secret']['card_key']
    card_token = response['card_secret']['card_token']
```

#### 3. Pay by Card Tokenï¼ˆå®šæœŸæ‰£æ¬¾ï¼‰

```python
# å¾Œç«¯ï¼šå®šæœŸæ‰£æ¬¾æ™‚ä½¿ç”¨
response = tappay.pay_by_card_token({
    'partner_key': PARTNER_KEY,
    'merchant_id': MERCHANT_ID,
    'card_key': user.subscription.tappay_card_key,
    'card_token': user.subscription.tappay_card_token,
    'amount': 99,
    'currency': 'TWD',
    'details': 'OderWhat åŸºç¤æ–¹æ¡ˆ - 2025/12',
    'cardholder': {
        'phone_number': user.phone,
        'name': user.name,
        'email': user.email
    }
})

if response['status'] == 0:
    # æ‰£æ¬¾æˆåŠŸ
    return True
else:
    # æ‰£æ¬¾å¤±æ•—
    error_msg = response['msg']
    return False
```

### é‡è¦é™åˆ¶

âš ï¸ **ä¸æ”¯æ´ remember åŠŸèƒ½çš„æ”¯ä»˜æ–¹å¼**ï¼š
- Apple Pay
- Google Pay
- Samsung Pay
- LINE Pay
- æ‚ éŠä»˜
- å…¨ç›ˆæ”¯ä»˜

**åªæœ‰ä¿¡ç”¨å¡æ”¯æ´å®šæœŸå®šé¡æ‰£æ¬¾**

---

## æŠ€è¡“æ¶æ§‹

### ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Frontend (React)                      â”‚
â”‚  â€¢ TapPay JS SDK                                 â”‚
â”‚  â€¢ ä»˜æ¬¾è¡¨å–®ï¼ˆä¿¡ç”¨å¡æ¬„ä½ï¼‰                         â”‚
â”‚  â€¢ è¨‚é–±ç®¡ç†é é¢                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Backend (FastAPI)                     â”‚
â”‚  â€¢ /payment/tappay/create (é¦–æ¬¡ä»˜æ¬¾)             â”‚
â”‚  â€¢ /payment/tappay/recurring (å®šæœŸæ‰£æ¬¾)          â”‚
â”‚  â€¢ /payment/tappay/webhook (ç‹€æ…‹é€šçŸ¥)            â”‚
â”‚  â€¢ /subscriptions/* (è¨‚é–±ç®¡ç†)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Firestore    â”‚   â”‚   TapPay API     â”‚
â”‚  â€¢ users       â”‚   â”‚  â€¢ Pay by Prime  â”‚
â”‚  â€¢ orders      â”‚   â”‚  â€¢ Pay by Token  â”‚
â”‚  â€¢ usage_logs  â”‚   â”‚  â€¢ Webhook       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæµç¨‹

#### æµç¨‹ 1ï¼šé¦–æ¬¡è¨‚é–±ä»˜æ¬¾

```
1. å‰ç«¯ï¼šä½¿ç”¨è€…å¡«å¯«ä¿¡ç”¨å¡è³‡æ–™
2. å‰ç«¯ï¼šTapPay JS SDK ç”¢ç”Ÿ primeï¼ˆä¸ç¶“éä½ çš„ä¼ºæœå™¨ï¼‰
3. å‰ç«¯ï¼šå°‡ prime å‚³çµ¦å¾Œç«¯ POST /payment/tappay/create
4. å¾Œç«¯ï¼šå‘¼å« TapPay Pay by Prime API (remember=true)
5. å¾Œç«¯ï¼šæ”¶åˆ° card_key + card_token
6. å¾Œç«¯ï¼šå„²å­˜åˆ° Firestore users/{user_id}.subscription
7. å¾Œç«¯ï¼šå»ºç«‹è¨‚å–®è¨˜éŒ„ orders/{order_id}
8. å¾Œç«¯ï¼šæ›´æ–°ä½¿ç”¨è€…è¨‚é–±ç‹€æ…‹
9. å‰ç«¯ï¼šé¡¯ç¤ºä»˜æ¬¾æˆåŠŸ
```

#### æµç¨‹ 2ï¼šå®šæœŸæ‰£æ¬¾ï¼ˆæ¯æœˆè‡ªå‹•ï¼‰

```
1. Cloud Scheduler è§¸ç™¼ /scheduled/subscription-renewal
2. å¾Œç«¯ï¼šæŸ¥è©¢æ˜å¤©è¦çºŒç´„çš„ä½¿ç”¨è€…
3. å¾Œç«¯ï¼šå‘¼å« TapPay Pay by Card Token API
   - ä½¿ç”¨å„²å­˜çš„ card_key + card_token
   - é‡‘é¡ï¼š99 æˆ– 299ï¼ˆä¾æ–¹æ¡ˆï¼‰
4a. æ‰£æ¬¾æˆåŠŸï¼š
    - æ›´æ–° subscription.current_period_end (+30å¤©)
    - é‡ç½® usage.monthly_count = 0
    - ç™¼é€æˆåŠŸ Email
4b. æ‰£æ¬¾å¤±æ•—ï¼š
    - æ¨™è¨˜ subscription.status = 'payment_failed'
    - ç™¼é€å¤±æ•— Emailï¼ˆè«‹æ›´æ–°ä»˜æ¬¾æ–¹å¼ï¼‰
    - æä¾› 3 å¤©å¯¬é™æœŸ
```

#### æµç¨‹ 3ï¼šæ›´æ›ä¿¡ç”¨å¡

```
1. ä½¿ç”¨è€…åœ¨è¨‚é–±ç®¡ç†é é¢é»æ“Šã€Œæ›´æ›ä¿¡ç”¨å¡ã€
2. å‰ç«¯ï¼šé¡¯ç¤º TapPay å¡è™Ÿè¼¸å…¥æ¬„ä½
3. å‰ç«¯ï¼šå–å¾—æ–°çš„ prime
4. å‰ç«¯ï¼šå‘¼å« POST /payment/tappay/update-card
5. å¾Œç«¯ï¼šå‘¼å« Pay by Prime (remember=true)
6. å¾Œç«¯ï¼šæ›´æ–° card_key + card_token
7. å¾Œç«¯ï¼šï¼ˆå¯é¸ï¼‰å‘¼å« Pay by Card Token æ‰£æ¬¾ NT$1 é©—è­‰
8. å¾Œç«¯ï¼šé©—è­‰æˆåŠŸå¾Œæ›´æ–°è³‡æ–™
9. å‰ç«¯ï¼šé¡¯ç¤ºæ›´æ–°æˆåŠŸ
```

---

## API æ•´åˆ

### 1. TapPay SDK å®‰è£

```bash
pip install tappay-python
```

æˆ–ä½¿ç”¨ HTTP Clientï¼š

```python
# integrations/tappay.py
import requests
import hashlib
import os

class TapPayService:
    def __init__(self):
        self.partner_key = os.getenv('TAPPAY_PARTNER_KEY')
        self.merchant_id = os.getenv('TAPPAY_MERCHANT_ID')
        self.base_url = os.getenv('TAPPAY_API_URL',
            'https://sandbox.tappaysdk.com/tpc')  # æ¸¬è©¦ç’°å¢ƒ

    def pay_by_prime(self, prime: str, amount: int,
                     user_info: dict, remember: bool = True) -> dict:
        """
        é¦–æ¬¡ä»˜æ¬¾ API

        Args:
            prime: å‰ç«¯å‚³ä¾†çš„ prime token
            amount: é‡‘é¡ï¼ˆæ–°å°å¹£ï¼‰
            user_info: ä½¿ç”¨è€…è³‡è¨Š
            remember: æ˜¯å¦å„²å­˜å¡ç‰‡è³‡è¨Šï¼ˆå®šæœŸæ‰£æ¬¾å¿…é ˆ Trueï¼‰

        Returns:
            {
                'status': 0,  # 0=æˆåŠŸ
                'msg': 'æˆåŠŸ',
                'rec_trade_id': '...',
                'card_secret': {
                    'card_key': '...',
                    'card_token': '...'
                }
            }
        """
        url = f'{self.base_url}/payment/pay-by-prime'

        payload = {
            'partner_key': self.partner_key,
            'prime': prime,
            'amount': amount,
            'merchant_id': self.merchant_id,
            'currency': 'TWD',
            'details': f"OderWhat è¨‚é–± - {user_info['email']}",
            'cardholder': {
                'phone_number': user_info.get('phone', '+886900000000'),
                'name': user_info['name'],
                'email': user_info['email']
            },
            'remember': remember
        }

        response = requests.post(url, json=payload)
        return response.json()

    def pay_by_card_token(self, card_key: str, card_token: str,
                         amount: int, user_info: dict) -> dict:
        """
        å®šæœŸæ‰£æ¬¾ API

        Args:
            card_key: å„²å­˜çš„å¡ç‰‡é‡‘é‘°
            card_token: å„²å­˜çš„å¡ç‰‡ token
            amount: é‡‘é¡
            user_info: ä½¿ç”¨è€…è³‡è¨Š

        Returns:
            {
                'status': 0,  # 0=æˆåŠŸ
                'msg': 'æˆåŠŸ',
                'rec_trade_id': '...'
            }
        """
        url = f'{self.base_url}/payment/pay-by-card-token'

        payload = {
            'partner_key': self.partner_key,
            'merchant_id': self.merchant_id,
            'card_key': card_key,
            'card_token': card_token,
            'amount': amount,
            'currency': 'TWD',
            'details': f"OderWhat æœˆè²» - {user_info['email']}",
            'cardholder': {
                'phone_number': user_info.get('phone', '+886900000000'),
                'name': user_info['name'],
                'email': user_info['email']
            }
        }

        response = requests.post(url, json=payload)
        return response.json()

    def verify_payment(self, rec_trade_id: str) -> dict:
        """
        æŸ¥è©¢äº¤æ˜“ç‹€æ…‹

        Args:
            rec_trade_id: TapPay äº¤æ˜“ç·¨è™Ÿ

        Returns:
            äº¤æ˜“è©³æƒ…
        """
        url = f'{self.base_url}/payment/record'

        payload = {
            'partner_key': self.partner_key,
            'rec_trade_id': rec_trade_id
        }

        response = requests.post(url, json=payload)
        return response.json()
```

### 2. å‰ç«¯æ•´åˆï¼ˆReactï¼‰

```tsx
// components/TapPayCardForm.tsx
import { useEffect, useState } from 'react';

export function TapPayCardForm({ onSuccess, amount }) {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    // è¼‰å…¥ TapPay JS SDK
    const script = document.createElement('script');
    script.src = 'https://js.tappaysdk.com/sdk/tpdirect/v5.18.0';
    script.async = true;
    script.onload = initTapPay;
    document.body.appendChild(script);
  }, []);

  const initTapPay = () => {
    TPDirect.setupSDK(
      APP_ID,      // TapPay APP ID
      APP_KEY,     // TapPay APP KEY
      'sandbox'    // 'sandbox' or 'production'
    );

    // è¨­å®šä¿¡ç”¨å¡æ¬„ä½
    TPDirect.card.setup({
      fields: {
        number: { element: '#card-number' },
        expirationDate: { element: '#card-expiry' },
        ccv: { element: '#card-ccv' }
      },
      styles: {
        'input': { 'font-size': '16px' },
        ':focus': { 'color': '#3b82f6' }
      }
    });

    setIsReady(true);
  };

  const handleSubmit = async () => {
    // å–å¾— prime
    TPDirect.card.getPrime((result) => {
      if (result.status !== 0) {
        alert('å–å¾— prime å¤±æ•—ï¼š' + result.msg);
        return;
      }

      const prime = result.card.prime;

      // å‚³çµ¦å¾Œç«¯
      fetch('/payment/tappay/create', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prime: prime,
          amount: amount,
          plan_type: 'basic',
          billing_cycle: 'monthly'
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          onSuccess(data);
        } else {
          alert('ä»˜æ¬¾å¤±æ•—ï¼š' + data.message);
        }
      });
    });
  };

  return (
    <div className="tappay-card-form">
      <h3>ä¿¡ç”¨å¡è³‡è¨Š</h3>

      <div className="form-group">
        <label>å¡è™Ÿ</label>
        <div id="card-number"></div>
      </div>

      <div className="form-row">
        <div className="form-group">
          <label>æœ‰æ•ˆæœŸé™</label>
          <div id="card-expiry"></div>
        </div>
        <div className="form-group">
          <label>å®‰å…¨ç¢¼</label>
          <div id="card-ccv"></div>
        </div>
      </div>

      <button
        onClick={handleSubmit}
        disabled={!isReady}
        className="pay-button"
      >
        ä»˜æ¬¾ NT$ {amount}
      </button>
    </div>
  );
}
```

### 3. å¾Œç«¯ API å¯¦ä½œ

```python
# routers/payment_tappay.py
from fastapi import APIRouter, Depends, HTTPException
from integrations.tappay import TapPayService
from services.subscription_service import SubscriptionService
from services.payment_service import PaymentService

router = APIRouter(prefix='/payment/tappay', tags=['payment'])
tappay = TapPayService()

@router.post("/create")
async def create_payment(
    request: PaymentRequest,
    user_info: dict = Depends(get_current_user)
):
    """
    é¦–æ¬¡è¨‚é–±ä»˜æ¬¾

    Request Body:
        {
            "prime": "...",
            "plan_type": "basic",
            "billing_cycle": "monthly"
        }
    """
    user_id = user_info['sub']

    # 1. è¨ˆç®—é‡‘é¡
    amount = calculate_amount(request.plan_type, request.billing_cycle)

    # 2. å‘¼å« TapPay API
    result = tappay.pay_by_prime(
        prime=request.prime,
        amount=amount,
        user_info={
            'email': user_info['email'],
            'name': user_info['name'],
            'phone': user_info.get('phone')
        },
        remember=True  # é–‹å•Ÿå®šæœŸæ‰£æ¬¾
    )

    if result['status'] != 0:
        raise HTTPException(400, f"ä»˜æ¬¾å¤±æ•—ï¼š{result['msg']}")

    # 3. å„²å­˜ card_key + card_token
    card_key = result['card_secret']['card_key']
    card_token = result['card_secret']['card_token']

    # 4. å»ºç«‹è¨‚å–®
    order = PaymentService.create_order(
        user_id=user_id,
        plan_type=request.plan_type,
        billing_cycle=request.billing_cycle,
        amount=amount,
        payment_provider='tappay',
        rec_trade_id=result['rec_trade_id']
    )

    # 5. æ›´æ–°è¨‚é–±
    SubscriptionService.create_subscription(
        user_id=user_id,
        plan=request.plan_type,
        cycle=request.billing_cycle,
        tappay_card_key=card_key,
        tappay_card_token=card_token
    )

    return {
        'status': 'success',
        'order_id': order['order_id'],
        'rec_trade_id': result['rec_trade_id']
    }


@router.post("/recurring")
async def charge_recurring():
    """
    å®šæœŸæ‰£æ¬¾ï¼ˆç”± Cloud Scheduler è§¸ç™¼ï¼‰

    æª¢æŸ¥æ˜å¤©è¦çºŒç´„çš„ä½¿ç”¨è€…ä¸¦æ‰£æ¬¾
    """
    from datetime import datetime, timedelta

    tomorrow = datetime.now() + timedelta(days=1)

    # æŸ¥è©¢æ˜å¤©è¦çºŒç´„çš„ä½¿ç”¨è€…
    users = db.collection('users')\
              .where('subscription.next_billing_date', '>=', tomorrow)\
              .where('subscription.next_billing_date', '<', tomorrow + timedelta(days=1))\
              .where('subscription.status', '==', 'active')\
              .stream()

    results = {
        'success': [],
        'failed': []
    }

    for user_doc in users:
        user_id = user_doc.id
        user_data = user_doc.to_dict()
        subscription = user_data['subscription']

        # è¨ˆç®—é‡‘é¡
        amount = calculate_amount(
            subscription['plan_type'],
            subscription['billing_cycle']
        )

        # å‘¼å« TapPay æ‰£æ¬¾
        result = tappay.pay_by_card_token(
            card_key=subscription['tappay_card_key'],
            card_token=subscription['tappay_card_token'],
            amount=amount,
            user_info={
                'email': user_data['email'],
                'name': user_data['name'],
                'phone': user_data.get('phone')
            }
        )

        if result['status'] == 0:
            # æ‰£æ¬¾æˆåŠŸ
            SubscriptionService.renew_subscription(user_id)
            results['success'].append(user_id)
        else:
            # æ‰£æ¬¾å¤±æ•—
            SubscriptionService.mark_payment_failed(user_id)
            send_payment_failed_email(user_id, result['msg'])
            results['failed'].append({
                'user_id': user_id,
                'reason': result['msg']
            })

    return results
```

---

## è³‡æ–™çµæ§‹

### Firestore Schema

#### users/{user_id}

```typescript
{
  // åŸºæœ¬è³‡è¨Š
  user_id: string,
  email: string,
  name: string,

  // è¨‚é–±è³‡è¨Š
  subscription: {
    plan_type: 'free' | 'basic' | 'pro',
    billing_cycle: 'monthly' | 'yearly' | null,
    status: 'active' | 'expired' | 'cancelled' | 'payment_failed',

    // TapPay å°ˆç”¨æ¬„ä½
    tappay_card_key: string | null,       // ğŸ”‘ å®šæœŸæ‰£æ¬¾ç”¨
    tappay_card_token: string | null,     // ğŸ”‘ å®šæœŸæ‰£æ¬¾ç”¨
    card_last_4: string | null,           // å¡è™Ÿæœ«å››ç¢¼ï¼ˆé¡¯ç¤ºç”¨ï¼‰
    card_type: string | null,             // å¡åˆ¥ï¼ˆVisa, Masterï¼‰

    // æ™‚é–“ç›¸é—œ
    subscribed_at: timestamp | null,
    current_period_start: timestamp,
    current_period_end: timestamp,
    next_billing_date: timestamp | null,
    cancelled_at: timestamp | null
  },

  // ä½¿ç”¨é‡
  usage: {
    monthly_count: number,
    monthly_limit: number,
    reset_date: timestamp
  }
}
```

#### orders/{order_id}

```typescript
{
  order_id: string,
  user_id: string,

  plan_type: 'basic' | 'pro',
  billing_cycle: 'monthly' | 'yearly',
  amount: number,
  currency: 'TWD',

  status: 'pending' | 'completed' | 'failed' | 'refunded',

  // TapPay å°ˆç”¨æ¬„ä½
  payment_provider: 'tappay',
  tappay_rec_trade_id: string | null,   // TapPay äº¤æ˜“ç·¨è™Ÿ
  tappay_bank_transaction_id: string | null,

  created_at: timestamp,
  paid_at: timestamp | null,

  metadata: {
    user_email: string,
    ip_address: string | null
  }
}
```

---

## å¯¦ä½œæµç¨‹

### Phase 1: TapPay å¸³è™Ÿç”³è«‹ï¼ˆ1 å¤©ï¼‰

1. **ç”³è«‹æ¸¬è©¦å¸³è™Ÿ**
   - å‰å¾€ï¼šhttps://portal.tappaysdk.com/register
   - å¡«å¯«å…¬å¸/å€‹äººè³‡è¨Š
   - å–å¾— APP_ID å’Œ APP_KEY

2. **è¨­å®šæ¸¬è©¦ç’°å¢ƒ**
   ```bash
   # .env.development
   TAPPAY_PARTNER_KEY=partner_xxxxx
   TAPPAY_MERCHANT_ID=your_merchant_id
   TAPPAY_APP_ID=xxxxx
   TAPPAY_APP_KEY=app_xxxxx
   TAPPAY_API_URL=https://sandbox.tappaysdk.com/tpc
   ```

3. **æ¸¬è©¦ä¿¡ç”¨å¡**
   - å¡è™Ÿï¼š`4242 4242 4242 4242`
   - æœ‰æ•ˆæœŸé™ï¼šä»»æ„æœªä¾†æ—¥æœŸ
   - CVVï¼šä»»æ„ 3 ç¢¼

### Phase 2: å¾Œç«¯å¯¦ä½œï¼ˆ3-5 å¤©ï¼‰

- [ ] Day 1: å»ºç«‹ `integrations/tappay.py`
- [ ] Day 2: å¯¦ä½œ `routers/payment_tappay.py`
- [ ] Day 3: æ•´åˆè¨‚é–±æœå‹™
- [ ] Day 4: å¯¦ä½œå®šæœŸæ‰£æ¬¾æ’ç¨‹
- [ ] Day 5: æ¸¬è©¦èˆ‡é™¤éŒ¯

### Phase 3: å‰ç«¯æ•´åˆï¼ˆ2-3 å¤©ï¼‰

- [ ] Day 6: è¼‰å…¥ TapPay JS SDK
- [ ] Day 7: å»ºç«‹ä¿¡ç”¨å¡è¼¸å…¥è¡¨å–®
- [ ] Day 8: æ•´åˆä»˜æ¬¾æµç¨‹

### Phase 4: æ¸¬è©¦èˆ‡ä¸Šç·šï¼ˆ2 å¤©ï¼‰

- [ ] Day 9: å®Œæ•´æ¸¬è©¦
- [ ] Day 10: æ­£å¼ç’°å¢ƒéƒ¨ç½²

**ç¸½è¨ˆ**: 8-11 å¤©ï¼ˆç´„ 2 é€±ï¼‰

---

## å®‰å…¨æ€§è€ƒé‡

### 1. PCI DSS åˆè¦

âœ… **TapPay å·²è™•ç†**
- å¡è™Ÿä¸ç¶“éä½ çš„ä¼ºæœå™¨
- å‰ç«¯ç›´æ¥èˆ‡ TapPay æºé€šç”¢ç”Ÿ prime
- ä½ åªéœ€è™•ç† prime token

### 2. Card Token å„²å­˜

âœ… **å®‰å…¨å»ºè­°**
```python
# åŠ å¯†å„²å­˜ï¼ˆå¯é¸ï¼‰
from cryptography.fernet import Fernet

def encrypt_token(token: str) -> str:
    f = Fernet(ENCRYPTION_KEY)
    return f.encrypt(token.encode()).decode()

def decrypt_token(encrypted: str) -> str:
    f = Fernet(ENCRYPTION_KEY)
    return f.decrypt(encrypted.encode()).decode()

# å„²å­˜æ™‚åŠ å¯†
user.subscription.tappay_card_token = encrypt_token(card_token)

# ä½¿ç”¨æ™‚è§£å¯†
card_token = decrypt_token(user.subscription.tappay_card_token)
```

### 3. API é‡‘é‘°ä¿è­·

âœ… **ç’°å¢ƒè®Šæ•¸**
```bash
# çµ•å°ä¸è¦ commit åˆ° git
TAPPAY_PARTNER_KEY=partner_xxxxx
TAPPAY_APP_KEY=app_xxxxx
```

âœ… **GCP Secret Manager**
```bash
gcloud secrets create tappay-partner-key \
  --data-file=tappay_key.txt
```

### 4. é˜²æ­¢é‡è¤‡æ‰£æ¬¾

âœ… **å†ªç­‰æ€§è¨­è¨ˆ**
```python
def charge_subscription(user_id: str, billing_date: date) -> dict:
    # æª¢æŸ¥æ˜¯å¦å·²æ‰£æ¬¾
    existing_order = db.collection('orders')\
        .where('user_id', '==', user_id)\
        .where('billing_date', '==', billing_date)\
        .where('status', '==', 'completed')\
        .limit(1)\
        .get()

    if existing_order:
        return {'status': 'already_charged'}

    # åŸ·è¡Œæ‰£æ¬¾...
```

---

## æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦ 1ï¼šé¦–æ¬¡è¨‚é–±ä»˜æ¬¾

```python
def test_first_subscription():
    # 1. ä½¿ç”¨è€…é¸æ“‡åŸºç¤æ–¹æ¡ˆ
    response = client.post('/payment/tappay/create', json={
        'prime': get_test_prime(),
        'plan_type': 'basic',
        'billing_cycle': 'monthly'
    }, headers={'Authorization': f'Bearer {token}'})

    assert response.status_code == 200
    assert response.json()['status'] == 'success'

    # 2. æª¢æŸ¥è¨‚é–±ç‹€æ…‹
    user = get_user('test_user')
    assert user['subscription']['plan_type'] == 'basic'
    assert user['subscription']['status'] == 'active'
    assert user['subscription']['tappay_card_key'] is not None
```

### æ¸¬è©¦ 2ï¼šå®šæœŸæ‰£æ¬¾æˆåŠŸ

```python
def test_recurring_charge_success():
    # è¨­å®šæ˜å¤©è¦çºŒç´„
    set_next_billing_date('test_user', tomorrow())

    # è§¸ç™¼å®šæœŸæ‰£æ¬¾
    response = client.post('/payment/tappay/recurring')

    assert 'test_user' in response.json()['success']

    # æª¢æŸ¥è¨‚é–±å·²çºŒç´„
    user = get_user('test_user')
    assert user['subscription']['current_period_end'] > datetime.now()
    assert user['usage']['monthly_count'] == 0  # å·²é‡ç½®
```

### æ¸¬è©¦ 3ï¼šæ‰£æ¬¾å¤±æ•—è™•ç†

```python
def test_recurring_charge_failed():
    # ä½¿ç”¨ç„¡æ•ˆçš„ card_token
    user = get_user('test_user')
    user['subscription']['tappay_card_token'] = 'invalid_token'
    update_user('test_user', user)

    # è§¸ç™¼æ‰£æ¬¾
    response = client.post('/payment/tappay/recurring')

    assert 'test_user' in [f['user_id'] for f in response.json()['failed']]

    # æª¢æŸ¥ç‹€æ…‹å·²æ¨™è¨˜ç‚ºå¤±æ•—
    user = get_user('test_user')
    assert user['subscription']['status'] == 'payment_failed'
```

---

## å¸¸è¦‹å•é¡Œ

### Q1: TapPay æ‰‹çºŒè²»å¦‚ä½•è¨ˆç®—ï¼Ÿ

**A**: 2.8%ï¼Œç„¡é¡å¤–è²»ç”¨
- åŸºç¤æ–¹æ¡ˆ NT$99ï¼šæ‰‹çºŒè²»ç´„ NT$2.77
- é€²éšæ–¹æ¡ˆ NT$299ï¼šæ‰‹çºŒè²»ç´„ NT$8.37

### Q2: å®šæœŸæ‰£æ¬¾æœƒè‡ªå‹•é€²è¡Œå—ï¼Ÿ

**A**: ä¸æœƒã€‚éœ€è¦ä½ è‡ªå·±å¯¦ä½œæ’ç¨‹ï¼ˆCloud Schedulerï¼‰å®šæœŸå‘¼å« Pay by Card Token API

### Q3: ä½¿ç”¨è€…å¯ä»¥æ›´æ›ä¿¡ç”¨å¡å—ï¼Ÿ

**A**: å¯ä»¥ã€‚é‡æ–°å‘¼å« Pay by Prime (remember=true) å–å¾—æ–°çš„ card_key + card_token

### Q4: å¦‚ä½•è™•ç†æ‰£æ¬¾å¤±æ•—ï¼Ÿ

**A**:
1. æ¨™è¨˜ subscription.status = 'payment_failed'
2. ç™¼é€ Email é€šçŸ¥
3. æä¾› 3 å¤©å¯¬é™æœŸ
4. å¯¬é™æœŸå¾Œé™ç´šç‚ºå…è²»æ–¹æ¡ˆ

### Q5: Apple Pay å¯ä»¥ç”¨æ–¼è¨‚é–±å—ï¼Ÿ

**A**: ä¸è¡Œã€‚Apple Pay ä¸æ”¯æ´ remember åŠŸèƒ½ï¼Œç„¡æ³•å–å¾— card_token

### Q6: å¦‚ä½•é€€æ¬¾ï¼Ÿ

**A**: ä½¿ç”¨ TapPay Refund API
```python
tappay.refund(rec_trade_id=order.tappay_rec_trade_id, amount=99)
```

---

## åƒè€ƒè³‡æº

### å®˜æ–¹æ–‡ä»¶

- **TapPay å¾Œç«¯æ–‡ä»¶**: https://docs.tappaysdk.com/tutorial/zh/back.html
- **Pay by Prime API**: https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-prime-api
- **Pay by Card Token API**: https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-card-token-api
- **TapPay Portal**: https://portal.tappaysdk.com/

### SDK èˆ‡å·¥å…·

- **Python SDK**: `pip install tappay-python`
- **JS SDK**: https://js.tappaysdk.com/sdk/tpdirect/v5.18.0
- **Postman Collection**: https://www.postman.com/tappay

### æ¸¬è©¦è³‡æº

- **æ¸¬è©¦å¡è™Ÿ**: 4242 4242 4242 4242
- **æ²™ç®±ç’°å¢ƒ**: https://sandbox.tappaysdk.com
- **æ¸¬è©¦æŒ‡å—**: https://docs.tappaysdk.com/tutorial/zh/test.html

---

## ä¸‹ä¸€æ­¥

1. âœ… **è¦æ ¼ç¢ºèªå®Œæˆ**
2. [ ] ç”³è«‹ TapPay æ¸¬è©¦å¸³è™Ÿ
3. [ ] é–‹å§‹å¾Œç«¯æ•´åˆ
4. [ ] å‰ç«¯è¡¨å–®é–‹ç™¼
5. [ ] å®Œæ•´æ¸¬è©¦
6. [ ] æ­£å¼ä¸Šç·š

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-24
**é‡‘æµæœå‹™å•†**: TapPay
**ç‹€æ…‹**: âœ… è¦æ ¼å®Œæˆï¼Œå»ºè­°æ¡ç”¨
